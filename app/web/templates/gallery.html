{% macro rating_badge(item, axis_id, axis, default=False) -%}
  {% set score = item.ratings.get(axis_id, item.rating if default else 0) %}
  <span
    class="badge rating-badge{% if not default %} axis-badge{% endif %}"
    data-rating-badge
    data-illust-id="{{ item.illust_id }}"
    data-axis-id="{{ axis_id }}"
    data-display-mode="{{ axis.display_mode }}"
    data-max="{{ axis.max_score }}"
    data-score="{{ score }}"
  >
    <span class="rating-output"></span>
    <span class="rating-gauge"><span class="rating-gauge-fill"></span></span>
  </span>
{%- endmacro %}

{% set show_list = display_mode in ['both', 'text'] %}
{% set show_grid = display_mode in ['both', 'image'] %}
{% set grid_class = 'gallery-grid size-' ~ size_mode %}

{% if illustrations %}
  {% if show_list %}
  <section class="view-panel" data-view="list">
    <table class="illust-table">
      <thead>
        <tr>
          <th style="width:26%">作品</th>
          <th style="width:18%">投稿日 / ブクマ日</th>
          <th style="width:14%">作者</th>
          <th style="width:8%">フラグ</th>
          <th style="width:18%">クイック編集</th>
          <th style="width:6%">ブクマ</th>
          <th style="width:6%">閲覧</th>
          <th style="width:4%">Pixiv</th>
        </tr>
      </thead>
      <tbody>
        {% for item in illustrations %}
        <tr data-illust-id="{{ item.illust_id }}">
          <td class="illust-title">
            <a href="{{ url_for('view_illust', illust_id=item.illust_id) }}">{{ item.title or 'タイトル未設定' }}</a>
            <div class="row-sub">最終 DL: {{ item.last_downloaded_at or '-' }}</div>
            <div class="row-sub">ID: {{ item.illust_id }}</div>
          </td>
          <td>
            <div class="row-sub">投稿日: {{ item.posted_at or '-' }}</div>
            <div class="row-sub">ブクマ日: {{ item.bookmarked_at or '-' }}</div>
          </td>
          <td>
            {% if item.artist %}
            <button type="button" class="meta-button" data-filter-artist="{{ item.artist }}">{{ item.artist }}</button>
            {% else %}
            <span class="row-sub">作者未設定</span>
            {% endif %}
          </td>
          <td>
            {% if item.is_r18 %}<span class="pill pill-r18">R-18</span>{% endif %}
            {% if item.is_ai %}<span class="pill pill-ai">AI</span>{% endif %}
          </td>
          <td>
            <div class="rating-stack">
              {{ rating_badge(item, default_axis_id, default_axis, True) }}
            </div>
            {% if secondary_axes %}
            <div class="axis-chips">
              {% for axis in secondary_axes %}
              <div class="axis-chip" data-axis-id="{{ axis.axis_id }}">
                <span class="axis-chip-label">{{ axis.name }}</span>
                {{ rating_badge(item, axis.axis_id, axis) }}
              </div>
              {% endfor %}
            </div>
            {% endif %}
            <div class="inline-editor"
                 data-inline-editor
                 data-illust-id="{{ item.illust_id }}"
                 data-axis-scores="{{ item.ratings|tojson|e }}"
                 data-default-rating="{{ item.ratings.get(default_axis_id, item.rating)|default(0, true) }}"
                 data-custom-tags="{{ item.custom_tags|join(', ')|e }}">
              <button type="button" class="inline-toggle" data-collapsed-label="クイック編集" data-expanded-label="閉じる">クイック編集</button>
              <div class="inline-body" hidden>
                <div class="inline-axes">
                  {% for axis in rating_axes %}
                  {% set current = item.ratings.get(axis.axis_id, item.rating if axis.axis_id == default_axis_id else 0) %}
                  <label class="inline-axis">
                    <span>{{ axis.name }}</span>
                    <select class="inline-axis-select" data-axis-id="{{ axis.axis_id }}">
                      {% for value in range(axis.max_score + 1) %}
                      <option value="{{ value }}" {{ 'selected' if current == value else '' }}>{{ value }}</option>
                      {% endfor %}
                    </select>
                  </label>
                  {% endfor %}
                </div>
                <label class="inline-tags">
                  <span>カスタムタグ</span>
                  <input type="text" class="inline-tags-input" value="{{ item.custom_tags|join(', ') }}" placeholder="例: 神構図, 旅ログ">
                </label>
                <div class="inline-actions">
                  <button type="button" class="inline-save">保存</button>
                  <span class="inline-status"></span>
                </div>
              </div>
            </div>
          </td>
          <td>{{ item.bookmark_count }}</td>
          <td>{{ item.view_count }}</td>
          <td><a href="https://www.pixiv.net/artworks/{{ item.illust_id }}" target="_blank" rel="noopener">表示</a></td>
        </tr>
        <tr class="tag-row">
          <td colspan="8">
            <div class="tag-panel" data-tag-panel>
              <div class="tag-list" data-tags data-illust-id="{{ item.illust_id }}">
                {% for tag in item.tags %}
                <button type="button" class="tag-button" data-filter-tag="{{ tag }}">{{ tag }}</button>
                {% endfor %}
                {% for tag in item.custom_tags %}
                <button type="button" class="tag-button custom" data-filter-tag="{{ tag }}">#{{ tag }}</button>
                {% endfor %}
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}

  {% if show_grid %}
  <section class="view-panel" data-view="grid">
    <div class="{{ grid_class }}">
      {% for item in illustrations %}
      <article class="card" data-illust-id="{{ item.illust_id }}">
        <figure>
          <a class="preview-link" href="{{ url_for('view_illust', illust_id=item.illust_id) }}">
            <img src="{{ url_for('serve_file', path=item.cover_path) }}" alt="{{ item.title or 'サムネイル' }}">
          </a>
          <figcaption>
            <strong>{{ item.title or 'タイトル未設定' }}</strong>
            <span>ページ {{ item.count }}</span>
          </figcaption>
        </figure>
        <div class="card-body">
          <div class="card-meta">
            {% if item.artist %}
            <button type="button" class="meta-button" data-filter-artist="{{ item.artist }}">{{ item.artist }}</button>
            {% endif %}
            <span>ID {{ item.illust_id }}</span>
          </div>
          <div class="flag-row">
            {% if item.is_r18 %}<span class="pill pill-r18">R-18</span>{% endif %}
            {% if item.is_ai %}<span class="pill pill-ai">AI</span>{% endif %}
          </div>
          <div class="rating-stack">
            {{ rating_badge(item, default_axis_id, default_axis, True) }}
          </div>
          {% if secondary_axes %}
          <div class="axis-chips">
            {% for axis in secondary_axes %}
            <div class="axis-chip">
              <span class="axis-chip-label">{{ axis.name }}</span>
              {{ rating_badge(item, axis.axis_id, axis) }}
            </div>
            {% endfor %}
          </div>
          {% endif %}
          <div class="inline-editor compact"
               data-inline-editor
               data-illust-id="{{ item.illust_id }}"
               data-axis-scores="{{ item.ratings|tojson|e }}"
               data-default-rating="{{ item.ratings.get(default_axis_id, item.rating)|default(0, true) }}"
               data-custom-tags="{{ item.custom_tags|join(', ')|e }}">
            <button type="button" class="inline-toggle" data-collapsed-label="クイック編集" data-expanded-label="閉じる">クイック編集</button>
            <div class="inline-body" hidden>
              <div class="inline-axes">
                {% for axis in rating_axes %}
                {% set current = item.ratings.get(axis.axis_id, item.rating if axis.axis_id == default_axis_id else 0) %}
                <label class="inline-axis">
                  <span>{{ axis.name }}</span>
                  <select class="inline-axis-select" data-axis-id="{{ axis.axis_id }}">
                    {% for value in range(axis.max_score + 1) %}
                    <option value="{{ value }}" {{ 'selected' if current == value else '' }}>{{ value }}</option>
                    {% endfor %}
                  </select>
                </label>
                {% endfor %}
              </div>
              <label class="inline-tags">
                <span>カスタムタグ</span>
                <input type="text" class="inline-tags-input" value="{{ item.custom_tags|join(', ') }}" placeholder="例: 描き込み, 旅ログ">
              </label>
              <div class="inline-actions">
                <button type="button" class="inline-save">保存</button>
                <span class="inline-status"></span>
              </div>
            </div>
          </div>
        </div>
      </article>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <nav class="pagination">
    {% if pagination.has_prev %}
    <a href="{{ build_url(page=1) }}">« 最初</a>
    <a href="{{ build_url(page=pagination.page - 1) }}">‹ 前へ</a>
    {% else %}
    <span class="disabled">« 最初</span>
    <span class="disabled">‹ 前へ</span>
    {% endif %}

    {% for p in pagination.window %}
      {% if p == pagination.page %}
      <span class="current">{{ p }}</span>
      {% else %}
      <a href="{{ build_url(page=p) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
    <a href="{{ build_url(page=pagination.page + 1) }}">次へ ›</a>
    <a href="{{ build_url(page=pagination.pages) }}">最後 »</a>
    {% else %}
    <span class="disabled">次へ ›</span>
    <span class="disabled">最後 »</span>
    {% endif %}
  </nav>
{% else %}
  <div class="empty-state">
    <p>条件に一致する作品が見つかりませんでした。フィルターを調整して再検索してください。</p>
  </div>
{% endif %}
